name: Docker publish

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: read
  packages: write

concurrency:
  group: docker-${{ github.ref }}
  cancel-in-progress: false

env:
  BACKEND_IMAGE: ${{ secrets.DOCKERHUB_LOGIN }}/tisk-backend
  FRONTEND_IMAGE: ${{ secrets.DOCKERHUB_LOGIN }}/tisk-frontend

jobs:
  # PREPARE
  prepare:
    name: ðŸ“‹ Prepare
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_major: ${{ steps.version.outputs.major }}
      version_minor: ${{ steps.version.outputs.minor }}
    steps:
      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION="${{ inputs.version }}"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Building version: $VERSION" >> $GITHUB_STEP_SUMMARY

  # BUILD AND PUSH BACKEND
  docker-backend:
    name: ðŸ³ Backend
    needs: prepare
    runs-on: ubuntu-latest
    outputs:
      digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_LOGIN }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.BACKEND_IMAGE }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ needs.prepare.outputs.version }}
            type=raw,value=${{ needs.prepare.outputs.version_major }}.${{ needs.prepare.outputs.version_minor }}
            type=raw,value=${{ needs.prepare.outputs.version_major }}
            type=sha,format=short
          labels: |
            org.opencontainers.image.title=TISK Backend
            org.opencontainers.image.version=${{ needs.prepare.outputs.version }}

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile-backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend
          platforms: linux/amd64,linux/arm64
          build-args: |
            BUILD_DATE=${{ github.event.release.created_at || github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ needs.prepare.outputs.version }}

  # BUILD AND PUSH FRONTEND
  docker-frontend:
    name: ðŸ³ Frontend
    needs: prepare
    runs-on: ubuntu-latest
    outputs:
      digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_LOGIN }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.FRONTEND_IMAGE }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ needs.prepare.outputs.version }}
            type=raw,value=${{ needs.prepare.outputs.version_major }}.${{ needs.prepare.outputs.version_minor }}
            type=raw,value=${{ needs.prepare.outputs.version_major }}
            type=sha,format=short
          labels: |
            org.opencontainers.image.title=TISK Frontend
            org.opencontainers.image.version=${{ needs.prepare.outputs.version }}

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile-frontend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend
          platforms: linux/amd64,linux/arm64
          build-args: |
            BUILD_DATE=${{ github.event.release.created_at || github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ needs.prepare.outputs.version }}

  # SUMMARY
  summary:
    name: ðŸ“‹ Summary
    needs: [prepare, docker-backend, docker-frontend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
          BACKEND_RESULT: ${{ needs.docker-backend.result }}
          FRONTEND_RESULT: ${{ needs.docker-frontend.result }}
          BACKEND_DIGEST: ${{ needs.docker-backend.outputs.digest }}
          FRONTEND_DIGEST: ${{ needs.docker-frontend.outputs.digest }}
        run: |
          echo "## ðŸ³ Docker build summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version: \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "| Image | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Backend image | ${{ needs.docker-backend.result == 'success' && 'âœ… Built & Pushed' || 'âŒ Skipped/Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Frontend image | ${{ needs.docker-frontend.result == 'success' && 'âœ… Built & Pushed' || 'âŒ Skipped/Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ³ Docker images" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Backend:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.BACKEND_IMAGE }}:${{ needs.release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.BACKEND_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Frontend:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.FRONTEND_IMAGE }}:${{ needs.release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.FRONTEND_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
