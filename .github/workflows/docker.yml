name: Docker Build & Push

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: read
  packages: write

env:
  BACKEND_IMAGE: ${{ secrets.DOCKERHUB_LOGIN }}/tisk-backend
  FRONTEND_IMAGE: ${{ secrets.DOCKERHUB_LOGIN }}/tisk-frontend

jobs:
  preflight:
    name: ðŸ” Preflight checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup JDK 21
        uses: actions/setup-java@v5.1.0
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Run quick tests
        run: |
          chmod +x gradlew
          ./gradlew test --no-daemon -x integrationTest 2>/dev/null || ./gradlew test --no-daemon

  docker-backend:
    name: ðŸ³ Backend Image
    needs: preflight
    runs-on: ubuntu-latest
    outputs:
      digest: ${{ steps.build.outputs.digest }}
      tags: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_LOGIN }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            # Fallback to SHA
            echo "version=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.BACKEND_IMAGE }}
          tags: |
            # Always set latest for release
            type=raw,value=latest,enable=${{ steps.version.outputs.is_release == 'true' }}
            # Full version
            type=raw,value=${{ steps.version.outputs.version }},enable=${{ steps.version.outputs.is_release == 'true' }}
            # Major, minor
            type=semver,pattern={{major}}.{{minor}},value=v${{ steps.version.outputs.version }},enable=${{ steps.version.outputs.is_release == 'true' }}
            # Major only
            type=semver,pattern={{major}},value=v${{ steps.version.outputs.version }},enable=${{ steps.version.outputs.is_release == 'true' && !startsWith(steps.version.outputs.version, '0.') }}
            # SHA for any
            type=sha,format=short
          labels: |
            org.opencontainers.image.title=TISK Backend
            org.opencontainers.image.version=${{ steps.version.outputs.version }}

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile-backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend
          platforms: linux/amd64,linux/arm64
          build-args: |
            BUILD_DATE=${{ github.event.release.created_at || github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ steps.version.outputs.version }}

  docker-frontend:
    name: ðŸ³ Frontend Image
    needs: preflight
    runs-on: ubuntu-latest
    outputs:
      digest: ${{ steps.build.outputs.digest }}
      tags: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_LOGIN }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
          elif [[ -n "${{ inputs.version }}" ]]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.FRONTEND_IMAGE }}
          tags: |
            type=raw,value=latest,enable=${{ steps.version.outputs.is_release == 'true' }}
            type=raw,value=${{ steps.version.outputs.version }},enable=${{ steps.version.outputs.is_release == 'true' }}
            type=semver,pattern={{major}}.{{minor}},value=v${{ steps.version.outputs.version }},enable=${{ steps.version.outputs.is_release == 'true' }}
            type=semver,pattern={{major}},value=v${{ steps.version.outputs.version }},enable=${{ steps.version.outputs.is_release == 'true' && !startsWith(steps.version.outputs.version, '0.') }}
            type=sha,format=short
          labels: |
            org.opencontainers.image.title=TISK Frontend
            org.opencontainers.image.version=${{ steps.version.outputs.version }}

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile-frontend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend
          platforms: linux/amd64,linux/arm64

  scan-images:
    name: ðŸ”’ Scan Images
    needs: [docker-backend, docker-frontend]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: backend
            image: ${{ needs.docker-backend.outputs.tags }}
          - name: frontend
            image: ${{ needs.docker-frontend.outputs.tags }}
    steps:
      - name: Run Trivy scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ secrets.DOCKERHUB_LOGIN }}/tisk-${{ matrix.name }}@${{ matrix.name == 'backend' && needs.docker-backend.outputs.digest || needs.docker-frontend.outputs.digest }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

  summary:
    name: ðŸ“‹ Summary
    needs: [docker-backend, docker-frontend, scan-images]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Docker build summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "### ðŸŽ‰ Release: ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          eecho "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          eecho "| ðŸ”’ Images scan | ${{ needs.scan-images.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Backend image | ${{ needs.docker-backend.result == 'success' && 'âœ… Built' || 'âŒ Skipped/Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Frontend image | ${{ needs.docker-frontend.result == 'success' && 'âœ… Built' || 'âŒ Skipped/Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ³ Docker images" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: \`${{ env.BACKEND_IMAGE }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`${{ env.FRONTEND_IMAGE }}:latest\`" >> $GITHUB_STEP_SUMMARY
